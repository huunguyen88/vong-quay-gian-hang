<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vòng Quay Gian Hàng</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f0f0f0; }
    .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .button:disabled { background-color: #ccc; cursor: not-allowed; }
    .reset { background-color: #dc3545; }
    input { padding: 8px; width: 100%; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; }
    #result { color: #333; font-weight: bold; }
    #remainingBooths { color: #555; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Vòng Quay Gian Hàng</h2>
    <input type="text" id="nameInput" placeholder="Nhập tên đối tác" />
    <button id="spinButton" class="button">Quay Vòng</button>
    <button id="resetButton" class="button reset">Reset Dữ Liệu</button>
    <p id="result">Kết quả sẽ hiển thị ở đây.</p>
  </div>

  <div class="card">
    <h3>Gian Hàng Còn Lại</h3>
    <p id="remainingBooths">Đang tải...</p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbw6Cy_PEaoIbUs1LzH-pYV2qHNSJWYmNyJs5bq3ZfAKe_4ycJk10e_ODE9invYLOH64/exec";
    let boothPositions = [
      "Gian hàng 1", "Gian hàng 2", "Gian hàng 3", "Gian hàng 4",
      "Gian hàng 5", "Gian hàng 6", "Gian hàng 7", "Gian hàng 8",
      "Gian hàng 9", "Gian hàng 10", "Gian hàng 11", "Gian hàng 12",
      "Gian hàng 13", "Gian hàng 14", "Gian hàng 15", "Gian hàng 16"
    ];

    const nameInput = document.getElementById("nameInput");
    const resultText = document.getElementById("result");
    const remainingText = document.getElementById("remainingBooths");
    const spinButton = document.getElementById("spinButton");
    const resetButton = document.getElementById("resetButton");

    let assignedBooths = [];

    async function fetchAssignedBooths() {
      try {
        console.log("Gửi GET tới:", `${scriptURL}?action=get`);
        const response = await fetch(`${scriptURL}?action=get`);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log("Dữ liệu nhận được:", data);
        assignedBooths = data.assigned || [];
        updateRemainingText();
      } catch (error) {
        console.error("Lỗi tải dữ liệu:", error);
        remainingText.textContent = "Không thể tải dữ liệu: " + error.message;
      }
    }

    function updateRemainingText() {
      const remaining = boothPositions.filter(b => !assignedBooths.includes(b));
      remainingText.textContent = remaining.length > 0 ? remaining.join(", ") : "Đã hết gian hàng.";
      spinButton.disabled = remaining.length === 0;
    }

    spinButton.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const availableBooths = boothPositions.filter(b => !assignedBooths.includes(b));

      if (!name) {
        alert("Vui lòng nhập tên đối tác!");
        return;
      }
      if (availableBooths.length === 0) {
        alert("Đã hết gian hàng!");
        return;
      }

      spinButton.disabled = true;
      spinButton.textContent = "Đang quay...";
      resultText.textContent = "Đang xử lý...";

      const selectedBooth = availableBooths[Math.floor(Math.random() * availableBooths.length)];

      try {
        console.log("Gửi POST:", { action: "assign", name, booth: selectedBooth });
        const response = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "assign", name: name, booth: selectedBooth })
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log("Phản hồi:", data);
        if (data.success) {
          assignedBooths.push(selectedBooth);
          resultText.textContent = `${name} đã nhận ${selectedBooth}`;
          nameInput.value = "";
          updateRemainingText();
        } else {
          resultText.textContent = "Có lỗi xảy ra: " + (data.error || "Không rõ lỗi");
        }
      } catch (error) {
        console.error("Lỗi gửi dữ liệu:", error);
        resultText.textContent = "Không thể kết nối server: " + error.message;
      } finally {
        spinButton.disabled = false;
        spinButton.textContent = "Quay Vòng";
      }
    });

    resetButton.addEventListener("click", async () => {
      const password = prompt("Nhập mật khẩu để reset dữ liệu:");
      if (!password) return;

      resetButton.disabled = true;
      resetButton.textContent = "Đang reset...";

      try {
        console.log("Gửi POST reset:", { action: "reset", password });
        const response = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "reset", password: password })
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log("Phản hồi reset:", data);
        if (data.success) {
          assignedBooths = [];
          updateRemainingText();
          resultText.textContent = "Dữ liệu đã được reset.";
        } else {
          alert("Mật khẩu sai hoặc có lỗi: " + (data.error || "Không rõ lỗi"));
        }
      } catch (error) {
        console.error("Lỗi reset dữ liệu:", error);
        resultText.textContent = "Không thể reset dữ liệu: " + error.message;
      } finally {
        resetButton.disabled = false;
        resetButton.textContent = "Reset Dữ Liệu";
      }
    });

    fetchAssignedBooths();
  </script>
</body>
</html>
